<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø³Ø§Ø¯Ù‡ Ø¯Ùˆ Ù†ÙØ±Ù‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .chat-container {
            width: 100%;
            max-width: 400px;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .status {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .users-count {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
        }
        
        .my-message {
            background: #dcf8c6;
            align-self: flex-start;
            border-bottom-right-radius: 5px;
        }
        
        .their-message {
            background: white;
            align-self: flex-end;
            border-bottom-left-radius: 5px;
        }
        
        .system-message {
            background: #ffeaa7;
            align-self: center;
            text-align: center;
            font-style: italic;
            max-width: 90%;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            text-align: left;
        }
        
        .input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            gap: 10px;
        }
        
        .input-container input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-family: inherit;
        }
        
        .input-container input:focus {
            border-color: #4CAF50;
        }
        
        .input-container button {
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .input-container button:hover {
            background: #45a049;
        }
        
        .input-container button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .full-chat {
            text-align: center;
            padding: 40px 20px;
            color: white;
            max-width: 400px;
        }
        
        .full-chat h2 {
            margin-bottom: 15px;
        }
        
        .connection-status {
            padding: 10px;
            text-align: center;
            background: #ffeb3b;
            color: #333;
            font-size: 14px;
        }
        
        @media (max-width: 480px) {
            .chat-container {
                height: 95vh;
                border-radius: 10px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="chatApp">
        <!-- ØµÙØ­Ù‡ Ú†Øª Ú©Ø§Ù…Ù„ -->
        <div id="fullChat" class="full-chat" style="display: none;">
            <h2>âŒ Ú†Øª Ú©Ø§Ù…Ù„ Ø§Ø³Øª!</h2>
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ùˆ Ù†ÙØ± Ø¯Ø± Ø­Ø§Ù„ Ú†Øª Ù‡Ø³ØªÙ†Ø¯</p>
            <p>Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
        </div>
        
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ú†Øª -->
        <div id="mainChat" class="chat-container">
            <div class="chat-header">
                <div class="users-count" id="usersCount">0/2</div>
                <h2>ğŸ’¬ Ú†Øª Ø³Ø§Ø¯Ù‡</h2>
                <div class="status" id="status">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
            </div>
            
            <div id="connectionStatus" class="connection-status" style="display: none;">
                ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                       maxlength="500" disabled>
                <button id="sendButton" onclick="sendMessage()" disabled>ğŸ“¤ Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒå…¨å±€
        let socket = null;
        let isConnected = false;
        let currentUserNumber = 0;
        
        // Ø¹Ù†Ø§ØµØ± DOM
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const statusDiv = document.getElementById('status');
        const usersCountDiv = document.getElementById('usersCount');
        const mainChat = document.getElementById('mainChat');
        const fullChat = document.getElementById('fullChat');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        function connectToServer() {
            socket = io({
                timeout: 10000,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§ØªØµØ§Ù„
            socket.on('connect', () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø´Ø¯ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
                isConnected = true;
                statusDiv.innerHTML = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª...';
                connectionStatus.style.display = 'none';
            });
            
            // ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…ØªØµÙ„ Ø´Ø¯
            socket.on('userConnected', (data) => {
                currentUserNumber = data.userNumber;
                statusDiv.innerHTML = `ğŸŸ¢ Ø´Ù…Ø§ Ú©Ø§Ø±Ø¨Ø± ${data.userNumber} Ù‡Ø³ØªÛŒØ¯`;
                usersCountDiv.textContent = `${data.userNumber}/${data.maxUsers}`;
                addSystemMessage('Ø´Ù…Ø§ Ø¨Ù‡ Ú†Øª Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯');
                
                if (data.userNumber === 1) {
                    addSystemMessage('Ù…Ù†ØªØ¸Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ…...');
                }
            });
            
            // ÙˆÙ‚ØªÛŒ Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯Ù†Ø¯
            socket.on('bothUsersOnline', () => {
                statusDiv.innerHTML = 'ğŸŸ¢ğŸŸ¢ Ú†Øª ÙØ¹Ø§Ù„ - Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†';
                usersCountDiv.textContent = `2/2`;
                addSystemMessage('Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ… Ù…ØªØµÙ„ Ø´Ø¯ âœ… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†Øª Ú©Ù†ÛŒØ¯');
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† input
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            });
            
            // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
            socket.on('newMessage', (data) => {
                const isMyMessage = data.userNumber === currentUserNumber;
                addMessage(data.text, isMyMessage, data.timestamp);
            });
            
            // ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ù‚Ø·Ø¹ Ø´Ø¯
            socket.on('userDisconnected', () => {
                addSystemMessage('Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ… Ù‚Ø·Ø¹ Ø´Ø¯ âŒ Ù…Ù†ØªØ¸Ø± Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...');
                statusDiv.innerHTML = 'ğŸŸ¡ Ù…Ù†ØªØ¸Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ…...';
                usersCountDiv.textContent = `1/2`;
                
                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† input
                messageInput.disabled = true;
                sendButton.disabled = true;
            });
            
            // Ø§Ú¯Ø± Ú†Øª Ù¾Ø± Ø¨Ø§Ø´Ø¯
            socket.on('chatFull', () => {
                mainChat.style.display = 'none';
                fullChat.style.display = 'block';
            });
            
            // Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø·
            socket.on('disconnect', (reason) => {
                console.log('âŒ Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø·:', reason);
                isConnected = false;
                statusDiv.innerHTML = 'ğŸ”´ Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø·';
                messageInput.disabled = true;
                sendButton.disabled = true;
                
                if (reason === 'io server disconnect') {
                    // Ø³Ø±ÙˆØ± Ù‚Ø·Ø¹ Ø´Ø¯Ù‡
                    connectionStatus.style.display = 'block';
                    setTimeout(() => {
                        socket.connect();
                    }, 2000);
                }
            });
            
            // Ø®Ø·Ø§
            socket.on('error', (error) => {
                console.error('âŒ Ø®Ø·Ø§ÛŒ Socket:', error);
                addSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· âŒ');
            });
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && isConnected) {
                socket.emit('sendMessage', { text: message });
                messageInput.value = '';
            }
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙØ­Ù‡
        function addMessage(text, isMyMessage, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${time}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = function() {
            connectToServer();
        };
        
        // Ø±ÙØ±Ø´ ØµÙØ­Ù‡
        function refreshPage() {
            location.reload();
        }
    </script>
</body>
</html>